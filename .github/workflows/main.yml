name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      - name: Configure Core RDP Settings
        run: |
          # Enable Screen Sharing (VNC server)
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist || true
          
          # Configure firewall 
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate off || true

      - name: Create RDP User with Secure Password  
        run: |
          # Generate secure password
          password=$(openssl rand -base64 16 | tr -d "=+/" | cut -c1-16)
          
          # Create admin user
          sudo sysadminctl -addUser RDP -fullName "RDP User" -password "$password" -admin
          
          echo "RDP_CREDS=User: RDP | Password: $password" >> $GITHUB_ENV

      - name: Install Tailscale (Official GitHub Action)
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Get Tailscale IP
        run: |
          # Get Tailscale IP
          tsIP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "Tailscale IP: $tsIP"

      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Test VNC port (5900) 
          if nc -z $TAILSCALE_IP 5900; then
              echo "VNC connectivity successful!"
          else
              echo "VNC connection test failed - but may still work"
          fi

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== RDP ACCESS ==="
          echo "Address: $TAILSCALE_IP:5900 (VNC)"
          echo "Username: RDP"  
          echo "$RDP_CREDS"
          echo "=================="
          echo ""
          
          while true; do
              echo "[$(date)] RDP Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
