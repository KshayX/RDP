name: RDP
on:
  workflow_dispatch:
jobs:
  secure-rdp:
    runs-on: macos-latest
    timeout-minutes: 360
    steps:
      - name: Configure macOS Screen Sharing
        run: |
          # Enable Screen Sharing (more reliable method)
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist || true
          
          # Enable Remote Management
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -allowAccessFor -allUsers -restart -agent || true

      - name: Create Admin User (Simplified)
        run: |
          # Generate password
          password=$(openssl rand -base64 12 | tr -d "=+/")
          
          # Use sysadminctl (more reliable than dscl on GitHub runners)
          sudo sysadminctl -addUser RDP -fullName "RDP User" -password "$password" -admin
          
          # Configure for Screen Sharing
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -configure -users RDP -access -on -privs -all || true
          
          echo "RDP_CREDS=User: RDP | Password: $password" >> $GITHUB_ENV

      - name: Install Tailscale (Direct Download)
        run: |
          # Download Tailscale directly (avoid Homebrew complexity)
          curl -L -o /tmp/tailscale.tgz https://pkgs.tailscale.com/stable/tailscale_1.76.1_darwin_amd64.tgz
          
          cd /tmp
          tar xzf tailscale.tgz
          
          # Install binaries
          sudo cp tailscale_*/tailscale /usr/local/bin/
          sudo cp tailscale_*/tailscaled /usr/local/bin/
          
          # Start tailscaled in background
          sudo /usr/local/bin/tailscaled &
